# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

MovieTier is a social movie companion app built as a course project (CPEN 321). It enables users to rank movies, share them with friends, and get personalized recommendations. The app consists of an Android frontend (Kotlin + Jetpack Compose) and a Node.js backend (TypeScript + Express + MongoDB).

## Repository Structure

```
CPEN321-MovieTier/
├── backend/                 # Node.js + TypeScript API server
│   ├── src/
│   │   ├── controllers/     # Request handlers (auth, movie, friend, feed, etc.)
│   │   ├── routes/          # Express route definitions
│   │   ├── models/          # Mongoose schemas (user, movie, friend, feed, watch)
│   │   ├── services/        # Business logic (auth, tmdb, sse, recommendations)
│   │   ├── middleware/      # Auth middleware and error handlers
│   │   ├── config/          # Configuration files
│   │   ├── utils/           # Utility functions
│   │   └── server.ts        # Express app entry point
│   ├── tests/               # Jest test files
│   ├── dist/                # Compiled JavaScript (generated by `npm run build`)
│   ├── package.json         # Dependencies and scripts
│   └── tsconfig.json        # TypeScript configuration
│
├── frontend/                # Android app (Kotlin + Jetpack Compose)
│   └── app/src/main/java/com/cpen321/movietier/
│       ├── data/            # Data layer
│       │   ├── api/         # Retrofit API interfaces
│       │   ├── repository/  # Repository implementations
│       │   ├── local/       # DataStore (TokenManager, SettingsManager)
│       │   └── model/       # DTOs
│       ├── di/              # Hilt dependency injection modules
│       ├── domain/          # Domain models and use cases
│       ├── ui/              # UI layer
│       │   ├── auth/        # Authentication screens
│       │   ├── profile/     # Profile screens
│       │   ├── friends/     # Friends management screens
│       │   ├── feed/        # Activity feed screens
│       │   ├── ranking/     # Movie ranking screens
│       │   ├── recommendation/ # Recommendation screens
│       │   ├── watchlist/   # Watchlist screens
│       │   ├── components/  # Reusable UI components
│       │   ├── viewmodels/  # ViewModels for each feature
│       │   ├── navigation/  # Navigation graph
│       │   └── theme/       # Material Design 3 theme
│       └── MainActivity.kt  # App entry point
│
└── documentation/           # Project documentation
```

## Architecture

### Backend (Node.js + TypeScript)
The backend follows a layered architecture with clear separation of concerns:

- **Routes** (`src/routes/`): Define API endpoints and map them to controllers
- **Controllers** (`src/controllers/`): Handle HTTP requests/responses, call services
- **Services** (`src/services/`): Contain business logic (e.g., `auth/authService.ts` handles Google OAuth verification)
- **Models** (`src/models/`): Mongoose schemas for MongoDB collections
  - `user/User.ts`: User accounts with Google authentication
  - `movie/RankedMovie.ts`: User movie rankings
  - `friend/Friend.ts`: Friend requests and friendships
  - `feed/FeedActivity.ts`: Activity feed entries
  - `watch/WatchlistItem.ts`: User watchlist items
- **Middleware** (`src/middleware/`): Authentication (`auth.ts`) and error handling
- **Config/Utils** (`src/config/`, `src/utils/`): Configuration and helper functions
  - `utils/logger.ts`: Structured logging utility with color-coded output (INFO, SUCCESS, WARN, ERROR, DEBUG, HTTP)

**Logging**: The backend uses a custom logger (`src/utils/logger.ts`) that provides color-coded console output with timestamps:
- `logger.info()` - Informational messages (cyan)
- `logger.success()` - Success operations (green)
- `logger.warn()` - Warnings (yellow)
- `logger.error()` - Errors (red)
- `logger.debug()` - Debug messages (magenta, only in development)
- `logger.http()` - HTTP request/response logs with duration

**Development**: Nodemon is configured (`nodemon.json`) to display file change notifications and auto-restart messages during development.

**Authentication Flow**: Google OAuth tokens are verified via `google-auth-library`, then JWT tokens are issued for subsequent requests. The `authenticate` middleware extracts and validates JWT tokens from the `Authorization: Bearer <token>` header.

**Database**: MongoDB with Mongoose ODM. Models use TypeScript interfaces extending `Document` and schemas with timestamps enabled.

### Frontend (Android + Kotlin)
The frontend follows Clean Architecture with MVVM pattern:

- **Data Layer** (`data/`):
  - `api/`: Retrofit API service interfaces
  - `repository/`: Data access abstractions (AuthRepository, MovieRepository, FriendRepository, FeedRepository)
  - `local/`: DataStore-based storage (TokenManager for JWT, SettingsManager for preferences)
  - `model/`: Data transfer objects
- **Domain Layer** (`domain/`):
  - `model/`: Domain entities
  - `usecase/`: Business logic use cases
- **UI Layer** (`ui/`):
  - Jetpack Compose screens organized by feature (auth, profile, friends, feed, ranking, recommendation)
  - ViewModels (`viewmodels/`) manage UI state and coordinate with repositories
  - `navigation/`: Navigation graph and composable navigation
  - `components/`: Reusable UI components
  - `theme/`: Material Design 3 theming
- **Dependency Injection** (`di/`): Hilt modules for providing dependencies
  - `NetworkModule.kt`: Configures Retrofit, OkHttp with auth interceptor that automatically adds JWT token from DataStore

**Authentication**: Uses Google Credential Manager API for Google Sign-In. Tokens are stored in DataStore and automatically injected into API requests via OkHttp interceptor.

## Common Commands

### Backend Development

```bash
# From backend/ directory
npm install                # Install dependencies
npm run dev                # Start development server with hot reload (nodemon + ts-node)
npm run build              # Compile TypeScript to JavaScript in dist/
npm start                  # Run compiled JavaScript (production)
npm test                   # Run Jest tests
```

**Starting the Backend**:
1. Ensure MongoDB is running (local instance or cloud connection)
2. Run `npm run dev` from the `backend/` directory
3. Server starts on port 3000 by default (configurable via `PORT` env var)
4. Watch console for connection confirmations (MongoDB, routes loaded)

**Environment Setup**: Copy `.env.example` to `.env` and configure:
- `MONGODB_URI`: MongoDB connection string
- `GOOGLE_CLIENT_ID`: Google OAuth Web Client ID
- `JWT_SECRET`: Secure random string for JWT signing
- `TMDB_API_KEY`: TMDB API key for movie data
- Firebase credentials (if using push notifications)

### Frontend Development

```bash
# From frontend/ directory
./gradlew build                    # Build the project
./gradlew assembleDebug            # Build debug APK
./gradlew assembleRelease          # Build release APK
./gradlew installDebug             # Build and install debug APK on connected device/emulator
./gradlew test                     # Run unit tests
./gradlew connectedAndroidTest     # Run instrumented tests on connected device/emulator
./gradlew signingReport            # Get SHA-1 fingerprint for Google OAuth setup
```

**Configuration**:
- Copy `local.defaults.properties` to `local.properties` and set:
  - `sdk.dir`: Path to Android SDK
  - `API_BASE_URL`: Backend URL (use `http://10.0.2.2:3000/api/` for emulator localhost)
  - `GOOGLE_CLIENT_ID`: Google OAuth Web Client ID

**Building**: Use Android Studio or Gradle. The project uses Kotlin DSL (`.kts` files), Jetpack Compose, and Hilt for dependency injection.

## API Endpoints

All endpoints are prefixed with `/api/`:

**Authentication** (`/api/auth`):
- `POST /auth/signin` - Sign in with Google ID token
- `POST /auth/signup` - Create account with Google ID token
- `POST /auth/signout` - Sign out (authenticated)
- `DELETE /auth/account` - Delete account (authenticated)

**Friends** (`/api/friends`):
- `GET /friends` - Get friends list
- `GET /friends/requests` - Get friend requests
- `POST /friends/request` - Send friend request
- `POST /friends/respond` - Accept/reject friend request
- `DELETE /friends/:friendId` - Remove friend

**Movies** (`/api/movies`):
- `GET /movies/search?query=...` - Search movies via TMDB
- `GET /movies/ranked` - Get user's ranked movies
- `POST /movies/rank` - Add and rank a movie
- `POST /movies/compare` - Compare two movies (interactive ranking)

**Feed** (`/api/feed`):
- `GET /feed` - Get friend activity feed
- Server-Sent Events (SSE) endpoint for real-time updates

**Recommendations** (`/api/recommendations`):
- `GET /recommendations` - Get movie recommendations

**Watchlist** (`/api/watchlist`):
- `GET /watchlist` - Get user's watchlist
- `POST /watchlist` - Add movie to watchlist
- `DELETE /watchlist/:movieId` - Remove from watchlist

## Key Implementation Details

### Google OAuth Setup
Requires Google Cloud Console project with:
- OAuth 2.0 Web Client credentials (for backend verification)
- OAuth 2.0 Android Client credentials (with SHA-1 fingerprint)
- Google+ API enabled
- Test users added during development

### Network Communication
- **Emulator**: Use `10.0.2.2` to access host machine's localhost
- **Physical Device**: Use computer's local IP address in `API_BASE_URL`

### Interactive Movie Ranking
The app uses a comparison-based ranking system (`movieComparisionController.ts` and `rerankController.ts`):
- Movies are ranked by pairwise comparisons rather than absolute positions
- When adding a movie, users compare it against existing ranked movies
- The `startRerank` endpoint initiates an interactive session for re-ordering existing rankings
- SSE service (`services/sse/`) provides real-time updates during ranking sessions

### Watchlist-Ranking Synchronization
Movies are automatically removed from watchlist when added to rankings:
- **Backend** (`movieComparisionController.ts`): The `removeFromWatchlistAll` helper is called in three cases:
  - Case 1: When adding the first movie to an empty ranking list
  - Case 2: When adding a duplicate movie (already ranked)
  - Case 3: When starting a comparison session (immediately, not after completion)
- **Frontend** (`WatchlistScreen.kt`): Automatically refreshes when navigating to the screen via:
  - `DisposableEffect` observing lifecycle `ON_RESUME` events
  - `LaunchedEffect` observing navigation back stack changes
- This ensures users don't see movies in their watchlist that they've already ranked

### Database Indexes
- `RankedMovie`: Compound index on `(userId, rank)` for efficient user ranking queries
- `FeedActivity`: Index on `createdAt` descending for chronological feed queries

### Error Handling
Backend uses centralized error handler middleware that returns standardized error responses with stack traces in development mode only.

## Testing

Backend tests use Jest. Frontend tests use JUnit and Espresso (test files would be in `app/src/test/` and `app/src/androidTest/`).

## Development Workflow Notes

- MongoDB must be running before starting backend
- Never commit `.env` or `local.properties` files
- TMDB API is used for movie search and metadata
- Firebase integration is configured but notification service implementation varies
- always add Co-authored-by: Kayli K-cheung@users.noreply.github.com (K-
  cheung@users.noreply.github.com)
for push
- do not add co-author by claude in commit messages
- check if Requirements_and_Design.md needs to be update after every fixes or improvement made
- push it to github after each fixes and improvement made
- only add change history to Requirements_and_Design.md if the actual contents inside changed.
- do not add claude to co-author in the commit message, always add Co-authored-by: Kayli <K-cheung@users.noreply.github.com>.
- do not add generated with claude in the commit message